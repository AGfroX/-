*原文：https://blog.leapmie.com/archives/418/*



大家都知道 HTTPS 比 HTTP 安全，也听说过与 HTTPS 协议相关的概念有 SSL 、非对称加密、 CA 证书等。



但对于以下灵魂三拷问可能就答不上了：

- **为什么用了 HTTPS 就是安全的？**
- **HTTPS 的底层原理如何实现？**
- **用了 HTTPS 就一定安全吗？**



本文将层层深入，从原理上把 HTTPS 的安全性讲透。



HTTPS 的实现原理



大家可能都听说过 HTTPS 协议之所以是安全的是因为 HTTPS 协议会对传输的数据进行加密，而加密过程是使用了非对称加密实现。



但其实，HTTPS 在内容传输的加密上使用的是对称加密，非对称加密只作用在证书验证阶段。





HTTPS 的整体过程分为证书验证和数据传输阶段，具体的交互过程如下：

![图片](HTTPS-%E5%BE%AE%E6%96%87.assets/640)



证书验证阶段：



- 浏览器发起 HTTPS 请求。
- 服务端返回 HTTPS 证书。
- 客户端验证证书是否合法，如果不合法则提示告警。



数据传输阶段：



- 当证书验证合法后，在本地生成随机数。
- 通过公钥加密随机数，并把加密后的随机数传输到服务端。
- 服务端通过私钥对随机数进行解密。
- 服务端通过客户端传入的随机数构造对称加密算法，对返回结果内容进行加密后传输。



为什么数据传输是用对称加密？



首先，非对称加密的加解密效率是非常低的，而 HTTP 的应用场景中通常端与端之间存在大量的交互，非对称加密的效率是无法接受的。



另外，在 HTTPS 的场景中只有服务端保存了私钥，一对公私钥只能实现单向的加解密，所以 HTTPS 中内容传输加密采取的是对称加密，而不是非对称加密。



为什么需要 CA 认证机构颁发证书？



HTTP 协议被认为不安全是因为传输过程容易被监听者勾线监听、伪造服务器，而 HTTPS 协议主要解决的便是网络传输的安全性问题。



首先我们假设不存在认证机构，任何人都可以制作证书，这带来的安全风险便是经典的“中间人攻击”问题。



“中间人攻击”的具体过程如下：

![图片](HTTPS-%E5%BE%AE%E6%96%87.assets/640)



过程原理如下：



- 本地请求被劫持（如 DNS 劫持等），所有请求均发送到中间人的服务器。
- 中间人服务器返回中间人自己的证书。
- 客户端创建随机数，通过中间人证书的公钥对随机数加密后传送给中间人，然后凭随机数构造对称加密对传输内容进行加密传输。
- 中间人因为拥有客户端的随机数，可以通过对称加密算法进行内容解密。
- 中间人以客户端的请求内容再向正规网站发起请求。
- 因为中间人与服务器的通信过程是合法的，正规网站通过建立的安全通道返回加密后的数据。
- 中间人凭借与正规网站建立的对称加密算法对内容进行解密。
- 中间人通过与客户端建立的对称加密算法对正规内容返回的数据进行加密传输。
- 客户端通过与中间人建立的对称加密算法对返回结果数据进行解密。



由于缺少对证书的验证，所以客户端虽然发起的是 HTTPS 请求，但客户端完全不知道自己的网络已被拦截，传输内容被中间人全部窃取。



浏览器是如何确保 CA 证书的合法性？





#### **①证书包含什么信息？**





证书包含信息如下：



- 颁发机构信息
- 公钥
- 公司信息
- 域名
- 有效期
- 指纹
- ......

####  

#### **②证书的合法性依据是什么？**





首先，权威机构是要有认证的，不是随便一个机构都有资格颁发证书，不然也不叫做权威机构。



另外，证书的可信性基于信任制，权威机构需要对其颁发的证书进行信用背书，只要是权威机构生成的证书，我们就认为是合法的。



所以权威机构会对申请者的信息进行审核，不同等级的权威机构对审核的要求也不一样，于是证书也分为免费的、便宜的和贵的。



#### **③浏览器如何验证证书的合法性？**



浏览器发起 HTTPS 请求时，服务器会返回网站的 SSL 证书。



浏览器需要对证书做以下验证：



- **验证域名、有效期等信息是否正确。**证书上都有包含这些信息，比较容易完成验证。
- **判断证书来源是否合法。**每份签发证书都可以根据验证链查找到对应的根证书，操作系统、浏览器会在本地存储权威机构的根证书，利用本地根证书可以对对应机构签发证书完成来源验证。



![图片](HTTPS-%E5%BE%AE%E6%96%87.assets/640)

- **判断证书是否被篡改。**需要与 CA 服务器进行校验。

- **判断证书是否已吊销。**通过 CRL（Certificate Revocation List 证书注销列表）和 OCSP（Online Certificate Status Protocol 在线证书状态协议）实现。

  其中 OCSP 可用于第 3 步中以减少与 CA 服务器的交互，提高验证效率。



以上任意一步都满足的情况下浏览器才认为证书是合法的。





**这里插一个我想了很久的但其实答案很简单的问题：**既然证书是公开的，如果要发起中间人攻击，我在官网上下载一份证书作为我的服务器证书，那客户端肯定会认同这个证书是合法的，如何避免这种证书冒用的情况？



其实这就是非加密对称中公私钥的用处，虽然中间人可以得到证书，但私钥是无法获取的。



一份公钥是不可能推算出其对应的私钥，中间人即使拿到证书也无法伪装成合法服务端，因为无法对客户端传入的加密数据进行解密。



#### **④只有认证机构可以生成证书吗？**



如果需要浏览器不提示安全风险，那只能使用认证机构签发的证书。



但浏览器通常只是提示安全风险，并不限制网站不能访问，所以从技术上谁都可以生成证书，只要有证书就可以完成网站的 HTTPS 传输。



例如早期的 12306 采用的便是手动安装私有证书的形式实现 HTTPS 访问。

![图片](HTTPS-%E5%BE%AE%E6%96%87.assets/640)



本地随机数被窃取怎么办？



证书验证是采用非对称加密实现，但是传输过程是采用对称加密，而其中对称加密算法中重要的随机数是由本地生成并且存储于本地的，HTTPS 如何保证随机数不会被窃取？



其实 HTTPS 并不包含对随机数的安全保证，HTTPS 保证的只是传输过程安全，而随机数存储于本地，本地的安全属于另一安全范畴，应对的措施有安装杀毒软件、反木马、浏览器升级修复漏洞等。



用了 HTTPS 会被抓包吗？



HTTPS 的数据是加密的，常规下抓包工具代理请求后抓到的包内容是加密状态，无法直接查看。



但是，正如前文所说，浏览器只会提示安全风险，如果用户授权仍然可以继续访问网站，完成请求。



因此，只要客户端是我们自己的终端，我们授权的情况下，便可以组建中间人网络，而抓包工具便是作为中间人的代理。



通常 HTTPS 抓包工具的使用方法是会生成一个证书，用户需要手动把证书安装到客户端中，然后终端发起的所有请求通过该证书完成与抓包工具的交互。



然后抓包工具再转发请求到服务器，最后把服务器返回的结果在控制台输出后再返回给终端，从而完成整个请求的闭环。



既然 HTTPS 不能防抓包，那 HTTPS 有什么意义？HTTPS 可以防止用户在不知情的情况下通信链路被监听，对于主动授信的抓包操作是不提供防护的，因为这个场景用户是已经对风险知情。



要防止被抓包，需要采用应用级的安全防护，例如采用私有的对称加密，同时做好移动端的防反编译加固，防止本地算法被破解。



总结



以下用简短的 Q&A 形式进行全文总结：



**Q：HTTPS 为什么安全？**



**A：**因为 HTTPS 保证了传输安全，防止传输过程被监听、防止数据被窃取，可以确认网站的真实性。



**Q：HTTPS 的传输过程是怎样的？**



**A：**客户端发起 HTTPS 请求，服务端返回证书，客户端对证书进行验证，验证通过后本地生成用于改造对称加密算法的随机数。



通过证书中的公钥对随机数进行加密传输到服务端，服务端接收后通过私钥解密得到随机数，之后的数据交互通过对称加密算法进行加解密。



**Q：为什么需要证书？**



**A：**防止“中间人”攻击，同时可以为网站提供身份证明。



**Q：使用 HTTPS 会被抓包吗？**



**A：**会被抓包，HTTPS 只防止用户在不知情的情况下通信被监听，如果用户主动授信，是可以构建“中间人”网络，代理软件可以对传输内容进行解密。



顺手分享一张学习 HTTPS 的过程图：



![图片](HTTPS-%E5%BE%AE%E6%96%87.assets/640)

【面试题专栏】

[24个经典的MySQL索引问题，你都遇到过哪些？](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484862&idx=1&sn=95b4514098a75ceba14f51797d0dc697&chksm=971b9bb5a06c12a3f101857a3160e42979bcd25661100626247097f3c33f607d9826528a2a18&scene=21#wechat_redirect)

[面试官：你对JVM垃圾收集器了解吗？13连问你是否抗的住？](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484829&idx=1&sn=15422a5bd4d162d3f284370f110151f3&chksm=971b9b96a06c1280219cbe5c6d28d1a7edd6de94dfbb309b049efe94447f05baebbdfa1e1d40&scene=21#wechat_redirect)

[Spring Cloud面试题万字解析（2020面试必备）](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484745&idx=1&sn=2aca31a4e4b6add4b8c6ff040ed613ac&chksm=971b9b42a06c1254db6ed2d07eb6f3f1fc3467ab6205372119114d44aafe6cd1f6d91466a162&scene=21#wechat_redirect)

[面试官：你对Redis缓存了解吗？面对这11道面试题你是否有很多问号？](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484669&idx=1&sn=50f6273dc5812409b6bba1741cafe27a&chksm=971b9af6a06c13e02ce88ec98bf4826f425d04deb8901354f5e6ff9b410e8153d5b863092b64&scene=21#wechat_redirect)
[2020年Java多线程与并发系列22道高频面试题解析](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484552&idx=1&sn=6b0acf6d7501997d5a145db92f78a486&chksm=971b9a83a06c1395addfbfda02ed0ef9790f2a730a39d228119ef5abc2bb0fb4bf1fc42a1190&scene=21#wechat_redirect)

[2020年Java基础高频面试题汇总（1.4W字详细解析）](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484486&idx=1&sn=650ca3ab865d0a5cc1eb53cf2d8392c2&chksm=971b9a4da06c135b068d4dd0d1f201e7571170d851fc540fce2032d2c14b79a83e037555c62a&scene=21#wechat_redirect)

[全网最全Spring系列面试题129道（附答案解析）](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484371&idx=1&sn=d1bbcee12e09f8bae10e5a5c7d28bd23&chksm=971b9dd8a06c14ce6c513fa4ba24760f783118516903a168d29851fc9a75015bb89a91eefe0f&scene=21#wechat_redirect)

[85道Java微服务面试题整理(助力2020面试）](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484271&idx=1&sn=cdf7216c9fa5a3ebc24e48ae266af27a&chksm=971b9d64a06c147200580dbca7b71fbc597fef884a11ee1645595a5f723c767a8a0e8bbdcec9&scene=21#wechat_redirect)

[2019年面试官最喜欢问的28道ZooKeeper面试题](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484182&idx=1&sn=611474b56f3068cf7f076b2137fb5601&chksm=971b9d1da06c140b954c44a8901619a51cba66387f012a7ed8e982aadbef717eba4372c95afc&scene=21#wechat_redirect)

[2020面试还搞不懂MyBatis？看看这27道面试题！（含答案和思维导图）](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484157&idx=1&sn=1f6fcb8cc8a5915fb6fefa08760c8c3c&chksm=971b9cf6a06c15e078ead521e3e84b46ea564e7301bbdbd67cfe6a21531b86d8a431df2523a3&scene=21#wechat_redirect)

[2019年常见的Linux面试题及答案解析，哪些你还不会？](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484109&idx=1&sn=bb152394d4f9084fa586d9ad93bb59f5&chksm=971b9cc6a06c15d0c0a4104c1af5fa7264800df2ac0472b63747a0cde5b2f0fb8c5c655ef218&scene=21#wechat_redirect)

[2019年常见Elasticsearch面试题答案解析](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484104&idx=1&sn=939eaf9feee7c4aee8139c0bc82ead77&chksm=971b9cc3a06c15d5683b1c90efecf0804d2bc3e8cec984c113a442e6a21f3c4785b1f523cceb&scene=21#wechat_redirect)

[18道kafka高频面试题哪些你还不会？（含答案和思维导图）](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484084&idx=1&sn=e4384fc5ac7f72893c1b6404752ca312&chksm=971b9cbfa06c15a9a8dae4343c3afb565ac80abb379455ab2a40a36e14d667b71eed2f9e3f9e&scene=21#wechat_redirect)

[2019年12道RabbitMQ高频面试题你都会了吗？（含答案解析）](http://mp.weixin.qq.com/s?__biz=MzIwNjg4MzY4NA==&mid=2247484076&idx=1&sn=08d53ffff4ace50bc63bf990424f52fe&chksm=971b9ca7a06c15b15a8c362927078e49aa6eb13c3d6de8acdb52c2b212e2b65f4b93167bc60d&scene=21#wechat_redirect)